时间触发以太网时钟同步的仿真与性能验证
TTE 全局时钟同步机制是其时间确定性保障的基本使能技术，对 TTE 时钟同步机制开展了建模仿真研究：提出 TTE 协议模块化的建模仿真方法，构建具有时钟漂移的设备时钟模型，采用离散事件调度的方法对 TTE 系统启动和重启动状态机以及时钟同步过程进行了系统模拟，研究了典型参数配置下 TTE 网络的时钟同步的性能，实现了对 TTE 时钟同步精度范围内微秒级同步的验证。

航空电子体系结构 TTE网络 建模仿真 时钟同步 时钟漂移 性能验证  

0“引言
随着航空电子体系结构向分布式综合模块化
( Distributed Integrated Modular Architecture, DIMA ) 结
构演进,其对于通信网络的高速、实时容错性能提出
了更高的需求。时间触发以太网“(Time-TriggedEth-
ermnet,TTE)作为一种能够提供严格的时间确定性与良
好的容错性能的网络,有望成为DIMA航空电子体系
结构的互连基础设施。
TTE网络在AFDX网络口的基础上引人了透明时
钟““和时钟同步的概念,并采用了时间触发Time
Triggered,TT)流量来传输航空电子系统中的关键性消
息。TT流量按照预先定义的时间调度表中的时间进
行发送,当网络同步情况变差时,会出现碰撞和冲突
现象““,严重影响航电系统中关键性任务流量的确定
性和实时性,因此,保证分布式设备间的时钟同步就显
得尤为重要。
目前,对于TTE网络时钟同步的分析主要集中于
对时钟同步算法的理论验证方面“““,在建模仿真方
面,文献[7]提出了利用0PNETXfTTE网络进行仿真
的方法,对网络流量的时延和抖动进行了分析,但未涉
及有关时钟同步的仿真过程。而TTE网络作为一种
能够提供完全的时间确定性的新型航空电子网络,在
传统航电网络的基础上添加了有关时钟同步的内容,
对其协议中建立与维持时钟同步的具体行为进行建模
仿真,可以还原TTE协议人的典型配置参数和同步过
程,有助于发现网络的同步性能边界,评估建立同步所
需的带宽占用比,并对网络的时钟同步精度和收敛性
进行评价。
本文对TTE网络的系统启动和重启动以及时钟
同步过程进行事件抽象,建立了模块化的事件行为模
型和具有时钟漂移的设备时钟模型,并采用离散事
件““调度的方式对其进行了仿真,从而验证了TTE网
络的时钟同步性能。
1TTE协议介绍
1.1TTE网络典型配置
TTE网络在标准以太网的基础上提供了时间确定
性和可靠性的保证。典型的单通信信道TTE网络的
物理拓扑如图1所示,包括端系统和交换机“。其中,
端系统和交换机通过双向通信链路连接。
同步控制器(SynchronizationMaster,SM)|、同步客户端
(Synchronization Client,SC) 和 压 缩 控 制 器 ( Compression
Master,CM)。其中,图1所示的物理拓扑可以构建为
如图2所示的同步拓扑。
TTE网络中系统的启动和重启动遮循严格定义的
协议状态机。协议状态机的状态主要分为非同步操作
状态和同步操作状态。系统的标准冷启动过程如图3
所示,SM和CM通过交换冷启动帧(ColdStartFrame,
CS) 和 冷 启 动 确 认 帧 ( Cold Start Acknowledge Frame,
CA)完成容错握手过程。然后,SM进人同步操作的状
态,开始发送集成帧(IntegrationFrame,IN)CM收到
满足条件的集成帧后,也进人同步操作状态。
在系统启动和重启动完成后,执行周期性的时钟
同步操作“““,如图4所示。第一步,由SM发起同步
过程,在每个集成周期(integrationcycle)的起点发送
集成帧,CM获取由SM传递的集成帧中的时间信息,
并利用压缩函数计算得到压缩时刻点,修正自身的本
地时钟;第二步,CM将计算得到的压缩时刻点的信息
通过压缩后的集成恭传递给SM和SC,SM和SC对压
缩函数传递的集成帧进行收集及处理,并对本地时钟
进行修正。
设计的仿真系统包括如图5所示的7个模块。将
其中的状态管理模块,数据处理模块以及时钟修正模
块作为主要模块进行详细设计,分别在2.1~2.3节中
进行具体介绍;设备及链路属性配置模块(依据5AE
AS6802标准对仿真用配置信息进行配置)同步拓扑
生成模块(依据设备及链路属性生成同步拓扑结构)、
结团检测模块(用于对网络中可能出现的结团情况进
行检测)以及结果输出模块作为辅助模块华助上述3
种主要模块实现仿真系统的相应功能。
TTE网络的协议状态机是TTE网络时钟同步服务
的框架结构,通过图5所示仿真系统囹中的状态管理
模块来设计实现。状态管理模块是仿真内核中的核心
模块,负责对系统启动和重启动过程中设备的状态以
及与当前状态相对应的执行行为进行管理。
在本文的设计中,将协议状态机中的每一个状态抽
象为一个事件,在状态事件中规定了当前状态下所要执
行的对应行为,并通过调用其他模块(数据处理,结团检
测\时钟修正模块)中的事件实现当前状态下具体行为
的执行。圭启动后,网络中的设备利用1.2节所述的方
式完成容错握手过程,然后,迹入华议状态机中用于表
示同步的同步操作状态,开始周期性地进行时钟同步。
下文以标准配置下CM的协议状态机模型为例进
行说明。图6为CM的状态转换图,CM的状态主要包
括集成(INTEGCRATE)状态、异步(UNSYNC)状态、使能
(CA_ENABLED)状态、等待(Wait_4_IN)状态和同步
状态。其中,同步状态包括TIE协议中的暂时同步
(TENTATIVE_SYNC) 、 同 步 (SYNC ) 和 稳 定 ( STABLE )
状态。状态管理模块利用由数据处理模块、结团检测
模块和时钟修正模块获得的信息,依据状态转换图中
的条件,判断是否进行状态转换。
图 6 标准配置下CM的状态转换′
Fig.6 CM state transition diagram for standard configuration
具体的,在每一个状态下,状态管理模块均执行与
当前状态相对应的事件。下文以CM的集成状态事件
为例进行说明。CM集成状态事件描述如下。
if(t < Timert ) then
if (recv IN )&&(M . > TTSov then
state?―SYNC
start Modulel & Module2
else
state?―UNSYNC
其中,!代表CM进人集成状态的时间,Timerl代
表 CM 在集成状态的定时器时长,M代表同步成员
变 量 (local_sync_membership) ,ITScu 代 表 由 集 成 状 态
到同步状态的状态跳转门限值,Modulel代表数据处
理模块,Module2代表时钟修正模块。设备进入集成状
态后,首先侦听时间长度为Timerl的时间,并判断在
Timert时间内,是否收到满足条件(M>I7TScu)的集
成帧,如果收到,则将当前状态置为同步状态,并启动
数据处理模块对接收到的集成帧进行处理,启动时钟
修正模块对设备的本地时钟进行修正;如果在Timerl
时间内没有收到滢足条件的集成帧,则将当前状态置
为异步状态。
2.2“数据处理模型
本文利用仿真系统中的数据处理模块(Modulel)
来模拟对协议控制恭(ProtocolControlFrames,PCF)的
数据处理过程。数据处理模块依据设备的当前状态来
完成对PCF的操作,可以划分为数据兖生成单元、数
据帧发送单元,数据帧接收单元.数据帧固化单元和数
据给压缩单元。其中,数据桢生成单元用来生成符合
TTE协议规定的PCF;数据帧发送和接收单元用来对
PCF进行发送和接收;数据帧固化单元用来依据PCF
的接收时刻点,以及TTE协议中有关固化时刻点的计
算方式获得PCF固化时刻点;数据帧压缩单元只存在
于CM中,用来根据在观察窗口范围内收集到的固化
后的PCF进行压缥处理。在TTE华议中给出了压缥
处理的方法,即利用收集到的PCF的固化时刻点计算
压缩修正值。
2.3“时钟修正模型
本文利用仿真系统中的时钟修正模块(Module2)来
模拟时钟修正过程。将时钟修正模块分为数据帧选择
单元、时钟修正计算单元和时钟修正执行单元。数据帧
选择单元用于选择最优的PCF,即具有最大的成员值
(pcft_membership_new)的PCF;时钟修正计算单元用于
计算当前集成周期下的时钟修正值4..;时钟修正执行
单元用于在时钟修正时刻点修正设备的本地时钟。
3TTE网络时钟同步分析
TTE网络的时钟同步算法采用状态修正(state-
correction)的方法,可以保证所设定的时钟精度范围内
的同步。实际过程中,由于晶振等影响,设备间的时钟
不可能达到完全同步,因此,在建立设备时钟模型时,
需要考虑时钟漂移(只考虑线性漂移的情况)。本节
首先对所建立的具有时钟漂移的设备时钟模型进行介
绍,然后从理论上对网络能够达到的时钟同步精度进
行了分析。
3.1“设备时钟模垣
为表述方便,在本文中将系统的集成周期长度记
为R,时钟精度记为p,设备的本地时钟记为TEAR
写字母表示),将实时时钟记为t(使用小写字母表
示),将时钟漂移率记为4(d>0代表快时钟,4=0代
表 标 准时钟,4<0代表慢时钟),将每个集成周期设备
时钟偏离标准时钟的程度记为4。初始状态下,将设
备的本地时钟与实时时钟的关系记为t=(1+d)xTs
对于如图2所示的同步拓扑结构,分别将SM1,
SM2的时钟模拟为快时钟和慢时钟,时钟偏移率分别
为 d (d, >0)F d,(d, <0) , 将 SM3 CM 和 SC 的 时 钟
模拟为标准时钟。
3.2“时钟同步精度分析
设备启动后,首先进人冷启动过程,理想情况下识
肢动过程的时序如图3所示。理论上,如果所有设备的
时钟均为标准时钟,那么在冷启动完成后,所有SM将在
同一时间起点发送IN帧,发起同步过程。侄是由于时钟
漂移的影响,SM发送IN帧的时间可能存在余差,设备
间的最大偏差记为A,,由于在名一集群(cluster)中SM
接收由同一个CM发送的CA帧,所以,4,主要取决于时
钟偏移率以及完成冷启动的时间长度Dcsu(一般情况
下,2R<Dosu,<3R),所以,在冷启动完成后,设备之间
的最大时钟偏差为
依据TTE协议,能够实现同步的设备间初始的时
钟偏差应该在2p以内,即4不2p。1Ay<2pmop2
及式(1)易知,在满足实现同步条件的一般情况下,应
配置
在进行时钟修正的理想情况下,每经历一个集成
周期,设备闻最大的时钟偏差4=(d,-d,)xR,HH,
4一4。理论上,在SM开始发起同步后,每个集成周
期开始的一段时间D,(D,,为由集成周期起始时刻
点到时钟修正时刻点所用的时间)均用来完成同步过
程,在时钟修正时刻点,具有时钟漂移的设备的本地时
钟被修正为与标准时钟完全一致。但是,在修正结束
后,设备的本地时钟还会继续按照自身的时钟漂移率
进行漂移,因此会出现各个设备本地时钟不完全一致
的情况。在后续的每个集成周期的起点,设备间的时
钟偏差4.均为(d,-02)x(R-D,,.)。由不等式(2)
GRA,<p,因此,在参数设置合理的情况下,设备间能
够达到时钟精度范围内的时钟局步,从而为TT流量的
传输提供有效保证。
然而,如果不进行时钟修正,则在n个集成周期后,
设备间最大的时钟偏差将达到4.=A,+nx4,当n足够
大时,设备间的非同步程度将会对网络的性能造成严
重影响,网络将不能再提供实时性和确定性的保证。
4TTE协议同步性能仿真
本文在VS2005的编译环境下,依据第2节所设计
的仿真模型进行仿真,通过仿真结果对TTEF网络的同
步性能进行分析。
4.1仿真环境设置
仿真场景设置为如图1所示的TTE网络,在该网
络中配置有3个SM,1I个CM和1个SC;传输速率设
署为100Mb/s;数据传输延迟.时钟漂移率和时钟精度
设置为微秒级。其中,设备的时钟采用3.1节所述的
时钟模型,将SMI,SM2的时钟漂移率4和4分别设
为 0. 001 和 -0. 001 。
4.2仿真实验与结果分析
1)同步仿真结果分析。
利用本文所述的仿真模型,分析了集成周期长度
对建立同步时间(冷启动完成所需时间)、维持同步时
间(每个集成局期开始绍持局步所需时间),设备间时
钟偏差以及同步带宽占用比的影响,如表1所示。
表 1 同步仿真统果
Table 1 Synchronization simulation results
1 wi 5 2708 149 “ 2 14.9
2 1500 5 3708 149 3 9.9
3 2000 5 4708 149 4 7.7
4100005未能进人稳定同步操作状态
5 t0000 - 50 , 21249 284 20 2.84
6 20000 50 41249 284 40 1.42
7100000-50“未能进人稳定同步操作状态
物理链路及网络配置参数不变的情况下,只改变
集成周期长度R,运行仿真程序获得不同情况下的建
立同步时间l、维持同步时间,以及系统进入稳定同
步状态后设备间时钟偏差4.,利用,与R的比值可以
计算获得同步带宽占用比A。
在仿真所配置的参数条件下,建立同步时闽i=
t+t,养中,设备启动后进行侦听的时间;,5RBA
倍数关系,容错握手过程如1.2节中图3所示,所需的
容错握手时间t与集成周期长度R无关。
分析表1中情况1~3和情况5~6可知,当史变
长时,建立同步时间5也会对应变长;由于网络配置
参数并未改变,维持同步时间b芥不会随着集成周期
的变化而变化;此外,设备间的时钟偏差会变大;同步
带宽占用比会随之下降。因此,增加集成周期长度能
够有效降低同步带宽占用比,但是也会带来更大的时
钟偏差,对时钟同步的性能造成影响,同时,还会导致
建立同步时间的增加。
下面将集成周期长度对5和b所造成的影响进
行综合考虑。当所设置的集群周期中包含个集成周
期时,自设备启动起的总的同步带宽占用比Aa=
(2R +1, ) +k xt,
(2R+1,) +kxR °
在表1的参数配置下,选取与情况1~3一致的时
钟精度,可分析总的同步带宽占用比
因为5>0,所以A与尸成单调递减的关系,当叉
增大时,Auu会随之减小。因此,对于总的同步带宽占
用比而言,集成周期长度R越小越好。但是R净小
时,稳定后每个集成周期的同步带宽占用比会增大,不
能有效地分配TT流量,因此,在设置集成周期长度时,
应将所需传输的TT流量的周期与总的同步带宽占用
比进行综合考虑。
情况4和7是参数设置的极端情况,不符合3.2
节中分析的能够实现同步的初始配置的一般情况(不
等式(2))。因此,设备未能进人稳定同步操作状态。
综上,在设置集成周期长度时,应综合考虑其对建
立、维持同步时间、同步带宽占用比和稳定后的设备间
时钟偏差的影响,依据所期望达到的具体需求进行具
体分析。
2)时钟同步精度及收敛性分析。
当将集成周期长度设置为!ms,时钟精度设置为
5hs,采用4.1节中的仿真环境设置时,利用仿真程序
对设备时钟在ie[0ms,8ms|的范围内进行仿真,仿
真的本地时钟与标准时钟的结果如图7所示。
量级,图7中修正部分表现得不是很明显,但是从中可
以观察出,设备的本地时钟整体上是收敛于标准时
钟的。
图 8 以本地时钟与标准时钟的偏差作为纵坐标
轴,对每个设备的时钟修正过程进行了进一步的说明。
表 冷 启动完成后每个集成周期的起点,分别为27087ms,
3.7087 ms,4. 7087 ms,5. 7087 ms,6. 7087 ms 和 7. 7087 ms
(每个集成周期长度为1ms),
在图8a中,由0到第1个集成周期起点2.7087ms,
为系统的冷启动过程,由于过程中未进行时钟修正,设
备间的时钟偏差达到最大值,此后,自每个集成周期开
始的一段时间,设备均进行时钟修正过程。在第1个
集成周期中,由于系统中的设备还未完全进人稳定状
态,因此,在时钟修正结李时刻点,仍然会存在0.1ps
量级的偏差(在时钟精度的范围内)。时钟修正结束后,
由于设备本身的属性,仍然存在时钟漂移,因此,在到达
下一集成周期时,时钟偏差又会变大,达到2pus左右,需
要进行新一轮的时钟同步。在后续的集成周期中,设备
趋于同步稳态,设备之间的时钟偏差会一致保持在2ps
范围内,小于所设置的时钟精度值(5s),能够达到微
秒级的时钟同步。
如果设备之间没有建立时钟同步,则如图8b所
示,设备之间的时钟偏差将会随时间的流逝而越来越
大,在经历8ms的时间后,就可能达到16us的偏差,
远大于时钟精度值(5ps),可能导致不同设备的TT流
量在发送的过程中发生冲突,从而严重影响网络的确
定性和实时性。
5“结束语
本文依据TTE华议,并结合对TTE网络时钟同步
过程的理论分析,完成了对其系统启动和重启动以及
建立和维持时钟同步过程的完整的建模仿真。通过仿
真,对1~100ms内的不同集成周期长度对时钟同步
性能的影响进行了定量分析,并呈现了在1ms的集成
周期长度下应用TTE时钟同步机制对时钟同步精度
和收敛性的影响,证明了TTE时钟同步机制能够保证
设备间的时钟偏差在所设定的5us的时钟精度范围
内,为后续有关TTE网络时钟同步的深人研究奠定了
基础。
